# Source: child-workflows.md
# Patterns: sequential/parallel/conditional children, detached, workflow ID

# --- Basic parent-child ---

workflow ParentWorkflow(input: Input) -> (Result):
    # Simple child workflow call
    workflow ChildWorkflow(input.data) -> childResult

    # Child with options
    workflow ChildWorkflow(input.data) -> childResult2
        options(workflowExecutionTimeout: 1h, retryPolicy: {maxAttempts: 3})

    close Result{childResult, childResult2}

workflow ChildWorkflow(data: Data) -> (ChildResult):
    activity Step1(data)
    activity Step2(data)
    close ChildResult{success: true}

# --- Sequential decomposition ---

workflow DeployApplication(app: App) -> (DeployResult):
    # Each child has own failure boundary
    workflow DeployDatabase(app.database) -> dbResult
    workflow DeployBackend(app.backend) -> beResult
    workflow DeployFrontend(app.frontend) -> feResult
    workflow ConfigureRouting(app) -> routeResult

    close DeployResult{status: "deployed"}

workflow DeployDatabase(database: Database) -> (DeployResult):
    activity ProvisionDB(database)
    activity MigrateSchema(database)
    close DeployResult{status: "done"}

workflow DeployBackend(backend: Backend) -> (DeployResult):
    activity BuildBackend(backend)
    activity DeployContainer(backend)
    close DeployResult{status: "done"}

workflow DeployFrontend(frontend: Frontend) -> (DeployResult):
    activity BuildFrontend(frontend)
    activity DeployStatic(frontend)
    close DeployResult{status: "done"}

workflow ConfigureRouting(app: App) -> (DeployResult):
    activity SetupRoutes(app)
    close DeployResult{status: "done"}

# --- Parallel children ---

workflow ProcessBatch(items: []Item) -> (BatchResult):
    await all:
        for (item in items):
            workflow ProcessItem(item)

    close BatchResult{}

workflow ProcessItem(item: Item) -> (ItemResult):
    activity ProcessSingleItem(item) -> result
    close ItemResult{result}

# --- Conditional children ---

workflow Onboarding(user: User) -> (OnboardingResult):
    workflow CreateAccount(user) -> accountResult

    if (user.type == "enterprise"):
        workflow EnterpriseSetup(user) -> setupResult
    else:
        workflow StandardSetup(user) -> setupResult

    workflow SendWelcomeEmail(user) -> emailResult
    close OnboardingResult{success: true}

workflow CreateAccount(user: User) -> (AccountResult):
    activity CreateUserRecord(user)
    close AccountResult{success: true}

workflow EnterpriseSetup(user: User) -> (SetupResult):
    activity ConfigureEnterprise(user)
    close SetupResult{done: true}

workflow StandardSetup(user: User) -> (SetupResult):
    activity ConfigureStandard(user)
    close SetupResult{done: true}

workflow SendWelcomeEmail(user: User) -> (EmailResult):
    activity SendEmail(user.email, "Welcome!")
    close EmailResult{sent: true}

# --- Detached child (fire-and-forget) ---

workflow ParentWithDetach(order: Order) -> (OrderResult):
    activity ProcessOrder(order) -> result
    # Fire-and-forget notification
    detach workflow NotifyCustomer(order.customer)
    close OrderResult{status: "done"}

workflow NotifyCustomer(customer: Customer):
    activity SendNotification(customer)

# --- Supporting activities ---

activity Step1(data: Data):
    do_step1(data)

activity Step2(data: Data):
    do_step2(data)

activity ProvisionDB(database: Database):
    provision(database)

activity MigrateSchema(database: Database):
    migrate(database)

activity BuildBackend(backend: Backend):
    build(backend)

activity DeployContainer(backend: Backend):
    deploy(backend)

activity BuildFrontend(frontend: Frontend):
    build(frontend)

activity DeployStatic(frontend: Frontend):
    deploy(frontend)

activity SetupRoutes(app: App):
    setup(app)

activity ProcessSingleItem(item: Item) -> (Result):
    return process(item)

activity CreateUserRecord(user: User):
    db.insert(user)

activity ConfigureEnterprise(user: User):
    setup_enterprise(user)

activity ConfigureStandard(user: User):
    setup_standard(user)

activity SendEmail(email: string, message: string):
    send(email, message)

activity ProcessOrder(order: Order) -> (OrderResult):
    return process(order)

activity SendNotification(customer: Customer):
    notify(customer)
